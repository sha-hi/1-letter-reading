<!DOCTYPE html>
<html lang="ml" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Letter / Word Reading Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#667eea; --brand-2:#5568d3; --page:#ffffff; --text:#1f2937; --muted:#6b7280;
      --card:#f8f9fa; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --shadow:rgba(0,0,0,.16)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Noto Sans Malayalam', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding:12px
    }
    .shell{
      width:100%; max-width:560px; margin:auto
    }
    .page{
      display:none; background:var(--page); color:var(--text);
      border-radius:18px; padding:22px; box-shadow:0 12px 42px var(--shadow);
      animation:fade .35s ease
    }
    .page.active{display:block}
    @keyframes fade{from{opacity:0; transform:translateY(14px)} to{opacity:1; transform:translateY(0)}}
    h1{font-size:22px; text-align:center; color:var(--brand); margin-bottom:16px}
    .stack{display:grid; gap:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:16px; color:#374151}
    .input,.select{
      width:100%; padding:14px 12px; border-radius:12px; border:2px solid #e5e7eb;
      font-size:16px; background:#fff; outline:none; transition:border-color .2s
    }
    .input:focus,.select:focus{border-color:var(--brand)}
    .btn{
      width:100%; padding:14px 16px; border:0; border-radius:12px; font-weight:700;
      font-size:17px; cursor:pointer; background:var(--brand); color:#fff;
      transition:transform .12s, box-shadow .12s, background .12s
    }
    .btn:hover:not(:disabled){background:var(--brand-2); transform:translateY(-2px); box-shadow:0 8px 18px rgba(102,126,234,.35)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.secondary{background:#6c757d}
    .btn.ghost{background:#eef2ff; color:#1e3a8a}
    .btn.outline{background:#fff; color:var(--brand); border:2px solid var(--brand)}
    .muted{color:var(--muted); font-size:14px}
    .card{background:var(--card); border-radius:14px; padding:14px}
    .kpi{display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:12px}
    .chip{background:#eef2ff; color:#1e3a8a; padding:6px 10px; border-radius:999px; font-weight:700; font-size:14px}
    .letter{
      font-family:'Scheherazade New', serif; font-weight:700;
      font-size:120px; text-align:center; margin:10px 0; transition:transform .15s
    }
    .letter.red{color:#dc2626} .letter.blue{color:#2563eb}
    .scorebar{display:flex; justify-content:center; gap:8px; flex-wrap:wrap; font-size:16px}
    .leaderboard-item{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px; margin:8px 0; background:#fff; border-radius:12px; font-size:16px; border:1px solid #eef2f7
    }
    .leaderboard-item.first{background:linear-gradient(135deg,#ffd700 0%,#ffed4e 100%); font-weight:700}
    .leaderboard-item.second{background:linear-gradient(135deg,#c0c0c0 0%,#e8e8e8 100%)}
    .leaderboard-item.third{background:linear-gradient(135deg,#cd7f32 0%,#e8a87c 100%)}
    .rank{font-size:22px; font-weight:800; margin-right:10px}
    .congrats{
      background:linear-gradient(135deg,#22c55e 0%,#86efac 100%); color:#064e3b;
      padding:16px; border-radius:14px; text-align:center; font-size:18px; font-weight:800; animation:pulse 1s infinite
    }
    @keyframes pulse{0%,100%{transform:scale(1)} 50%{transform:scale(1.03)}}
    .empty{color:var(--muted); text-align:center; padding:18px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .controls .btn{flex:1; min-width:120px}
    .subtle{font-size:13px; color:#475569}
    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:480px){
      .page{padding:18px}
      h1{font-size:20px}
      .letter{font-size:92px}
      .btn{font-size:16px; padding:12px 14px}
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- Page 1: Onboarding -->
    <section id="page1" class="page active">
      <h1>Fast Reading Capability Building</h1>
      <div class="stack">
        <div>
          <label for="playerName" class="subtle">‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µç</label>
          <input id="playerName" class="input" type="text" placeholder="‡¥™‡µá‡¥∞‡µç ‡¥ü‡µà‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï‚Ä¶" oninput="ui.checkStartReady()" />
        </div>
        <div class="two-col">
          <div>
            <label for="mode" class="subtle">‡¥Æ‡µã‡¥°‡µç</label>
            <select id="mode" class="select" onchange="ui.checkStartReady()">
              <option value="letter">‡¥Ö‡¥ï‡µç‡¥∑‡¥∞‡¥ô‡µç‡¥ô‡µæ</option>
              <option value="word"> ‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥ï‡µæ</option>
            </select>
          </div>
          <div>
            <label for="duration" class="subtle">‡¥∏‡¥Æ‡¥Ø‡¥Ç</label>
            <select id="duration" class="select">
              <option value="15">15 second</option>
              <option value="20" selected>20 second</option>
              <option value="30">30 second</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button id="goLeaderboard" class="btn" disabled onclick="flows.toLeaderboard()">‡¥Ü‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç </button>
        </div>
        <div class="row">
          <button class="btn outline" onclick="flows.toCompetitionSetup()">üèÜ TWO PLAYER MATCH</button>
        </div>
      </div>
    </section>

    <!-- Page 2: Leaderboard -->
    <section id="page2" class="page">
      <h1>‡¥á‡¥§‡µÅ‡¥µ‡¥∞‡µÜ‡¥Ø‡µÅ‡¥≥‡µç‡¥≥ ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥∏‡µç‡¥ï‡µã‡¥±‡µÅ‡¥ï‡µæ</h1>
      <div class="card">
        <div id="leaderboardDisplay" class="stack"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="flows.startSolo()">‡¥ó‡µÜ‡¥Ø‡¥ø‡¥Ç ‡¥Ü‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
        <button class="btn secondary" onclick="flows.newPlayer()">BACK TO MENU</button>
        <button class="btn ghost" onclick="flows.toCompetitionSetup()">üèÜ TWO PLAYER MATCH</button>
      </div>
    </section>

    <!-- Page 3: Game -->
    <section id="page3" class="page">
      <h1 id="gameTitle">Reading Game</h1>
      <div class="kpi">
        <div class="chip">‚è±Ô∏è <span id="timer">20</span> sec</div>
        <div class="chip">‡¥∏‡µç‡¥ï‡µã‡µº: <span id="score">0</span></div>
        <div class="chip"><span id="modeChip">Letter</span></div>
      </div>
      <div id="letter" class="letter red">ÿ®Ÿé</div>
      <div class="controls">
        <button id="startBtn" class="btn" onclick="engine.startTimer()">‡¥Ü‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
        <button id="prevBtn" class="btn outline" onclick="engine.previous()" disabled>‡¥Æ‡µÅ‡¥Æ‡µç‡¥™‡¥§‡µç‡¥§‡µÜ‡¥§‡µç</button>
        <button id="nextBtn" class="btn" onclick="engine.next()" disabled>‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡¥§‡µç</button>
      </div>
      <div class="stack" style="margin-top:10px">
        <button class="btn secondary" onclick="flows.cancelRun()">go to back page</button>
      </div>
    </section>

    <!-- Page 4: Results -->
    <section id="page4" class="page">
      <h1>RESULT</h1>
      <div id="congratsMessage" class="stack"></div>
      <div class="card">
        <div class="scorebar">
          <div>üéØ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥∏‡µç‡¥ï‡µã‡µº: <b><span id="yourScore">0</span></b></div>
          <div>‚Ä¢</div>
          <div>‚è±Ô∏è ‡¥∏‡¥Æ‡¥Ø‡¥Ç: <b><span id="timeUsed">0</span> second</b></div>
          <div>‚Ä¢</div>
          <div>MODE: <b><span id="resultMode">‡¥Ö‡¥ï‡µç‡¥∑‡¥∞‡¥ô‡µç‡¥ô‡µæ </span></b></div>
        </div>
      </div>
      <div class="stack" style="margin-top:10px">
        <div id="finalLeaderboard" class="stack"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="flows.playAgain()">‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥ï‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
        <button class="btn secondary" onclick="flows.newPlayer()">MAIN MENU</button>
        <button class="btn secondary" onclick="admin.resetAllData()">‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥±‡µÄ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç</button>
      </div>
    </section>

    <!-- Page 5: Competition Setup -->
    <section id="page5" class="page">
      <h1>üèÜ ‡¥Æ‡¥§‡µç‡¥∏‡¥∞ ‡¥ï‡µç‡¥∞‡¥Æ‡µÄ‡¥ï‡¥∞‡¥£‡¥Ç</h1>
      <div class="stack">
        <div class="two-col">
          <div>
            <label class="subtle">Player 1</label>
            <input id="p1" class="input" placeholder="‡¥™‡µá‡¥∞‡µç‚Ä¶" />
          </div>
          <div>
            <label class="subtle">Player 2</label>
            <input id="p2" class="input" placeholder="‡¥™‡µá‡¥∞‡µç‚Ä¶" />
          </div>
        </div>
        <div class="two-col">
          <div>
            <label class="subtle">MODE</label>
            <select id="compMode" class="select">
              <option value="letter">Letter</option>
              <option value="word">Word</option>
            </select>
          </div>
          <div>
            <label class="subtle">‡¥∏‡¥Æ‡¥Ø‡¥Ç</label>
            <select id="compDur" class="select">
              <option value="15">15 second</option>
              <option value="20" selected>20 second</option>
              <option value="30">30 second</option>
            </select>
          </div>
        </div>
        <button class="btn" onclick="competition.start()">‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‡¥Ü‡¥∞‡¥Ç‡¥≠‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï</button>
        <button class="btn secondary" onclick="flows.newPlayer()">BACK TO MAIN PAGE</button>
      </div>
    </section>

    <!-- Page 6: Competition Result -->
    <section id="page6" class="page">
      <h1>üèÅ ‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‚Äî ‡¥´‡¥≤‡¥Ç</h1>
      <div id="compCongrats" class="stack"></div>
      <div class="card">
        <div id="compSummary" class="stack"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="flows.toCompetitionSetup()">‡¥Æ‡¥±‡µç‡¥±‡µä‡¥∞‡µÅ ‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç</button>
        <button class="btn secondary" onclick="flows.toLeaderboard()">‡¥≤‡µÄ‡¥°‡µº‡¥¨‡µã‡µº‡¥°‡¥ø‡¥≤‡µá‡¥Ø‡µç‡¥ï‡µç‡¥ï‡µç</button>
      </div>
    </section>

  </div>

  <script>
    // ---------- Data Pools ----------
    const rawLetters = ["ÿß","ÿ®","ÿ™","ÿ´","ÿ¨","ÿ≠","ÿÆ","ÿØ","ÿ∞","ÿ±","ÿ≤","ÿ≥","ÿ¥","ÿµ","ÿ∂","ÿ∑","ÿ∏","ÿπ","ÿ∫","ŸÅ","ŸÇ","ŸÉ","ŸÑ","ŸÖ","ŸÜ","Ÿá","Ÿà","Ÿä"];
    const harakats = ["Ÿé","Ÿê","Ÿè"];
    const extra = ["ÿßŸéÿ®Ÿí","ÿßŸéÿ™Ÿí","ÿßŸéÿ´Ÿí","ÿßŸéÿ¨Ÿí","ÿßŸéÿ≠Ÿí","ÿßŸéÿÆŸí","ÿßŸéÿØŸí","ÿßŸéÿ∞Ÿí","ÿßŸéÿ±Ÿí","ÿßŸéÿ≤Ÿí","ÿßŸéÿ≥Ÿí","ÿßŸéÿ¥Ÿí","ÿßŸéÿµŸí","ÿßŸéÿ∂Ÿí","ÿßŸéÿ∑Ÿí","ÿßŸéÿ∏Ÿí","ÿßŸéÿπŸí","ÿßŸéÿ∫Ÿí","ÿßŸé","ÿßŸéŸÇŸí","ÿßŸéŸÉŸí","ÿßŸéŸÑŸí","ÿßŸéŸÖŸí","ÿßŸéŸÜŸí","ÿßŸéŸáŸí","ÿßŸéŸàŸí","ÿßŸéŸäŸí"];
    const lettersPool = (() => {
      const arr = [...extra];
      rawLetters.forEach(l => harakats.forEach(h => arr.push(l + h)));
      return arr;
    })();

    // Simple wotrds list for word mode 
    
    const verbsPool = [
  // ‚úÖ Verbs
  "ŸÉŸéÿ™Ÿéÿ®Ÿé","ŸÇŸéÿ±Ÿéÿ£Ÿé","ÿ¨ŸéŸÑŸéÿ≥Ÿé","ŸÇŸéÿßŸÖŸé","ÿ∞ŸéŸáŸéÿ®Ÿé","ÿ¨Ÿéÿßÿ°Ÿé","ÿ≥Ÿéÿ£ŸéŸÑŸé","ÿ£ŸéŸÉŸéŸÑŸé","ÿ¥Ÿéÿ±Ÿêÿ®Ÿé","ŸÅŸéÿ™Ÿéÿ≠Ÿé",
  "ÿ£Ÿéÿ∫ŸíŸÑŸéŸÇŸé","ÿ≥ŸéŸÖŸêÿπŸé","ÿ±Ÿéÿ£ŸéŸâ","ÿØŸéÿÆŸéŸÑŸé","ÿÆŸéÿ±Ÿéÿ¨Ÿé","ŸÑŸéÿπŸêÿ®Ÿé","ÿ™ŸéÿπŸéŸÑŸëŸéŸÖŸé","ÿπŸéŸÑŸëŸéŸÖŸé","ÿ≠ŸéŸÅŸêÿ∏Ÿé","ÿ∞ŸéŸÉŸéÿ±Ÿé",
  "ŸÜŸéÿßŸÖŸé","ÿµŸéŸÑŸëŸéŸâ","ÿ∞Ÿéÿ®Ÿéÿ≠Ÿé","ÿ®ŸéÿßÿπŸé","ÿ¥Ÿéÿ±ŸéŸâ","ŸÅŸéŸáŸêŸÖŸé","ŸÇŸéÿßŸÑŸé","ŸàŸéŸÇŸéŸÅŸé","ÿ±ŸéŸÉŸêÿ®Ÿé","ÿ≥ŸéÿßŸÅŸéÿ±Ÿé",

  // ‚úÖ Nouns
  "ŸÉŸêÿ™Ÿéÿßÿ®Ÿå","ŸÇŸéŸÑŸéŸÖŸå","ŸÖŸéÿßÿ°Ÿå","ŸÑŸéÿ®ŸéŸÜŸå","ÿÆŸèÿ®Ÿíÿ≤Ÿå","ÿ®Ÿéÿßÿ®Ÿå","ÿ®ŸéŸäŸíÿ™Ÿå","ŸÉŸèÿ±Ÿíÿ≥ŸêŸäŸëŸå",
  "ŸÖŸéÿØŸíÿ±Ÿéÿ≥Ÿéÿ©Ÿå","ŸÖŸèÿπŸéŸÑŸëŸêŸÖŸå","ÿ™ŸêŸÑŸíŸÖŸêŸäÿ∞Ÿå","ÿ≥ŸéŸäŸëŸéÿßÿ±Ÿéÿ©Ÿå","ŸÉŸèÿ±Ÿéÿ©Ÿå","ÿ≠ŸêŸÖŸéÿßÿ±Ÿå","ŸÇŸêÿ∑ŸëŸå",
  "ŸÉŸéŸÑŸíÿ®Ÿå","ÿ≥ŸéŸÖŸéŸÉŸå","ÿ∑Ÿéÿßÿ¶Ÿêÿ±Ÿå","ÿ¨Ÿéÿ®ŸéŸÑŸå","ÿ¥Ÿéÿ¨Ÿéÿ±Ÿéÿ©Ÿå"
];


    // ---------- State ----------
    const state = {
      player: "",
      mode: "letter",
      duration: 20,
      history: [],
      idx: -1,
      score: 0,
      timer: null,
      gameActive: false,
      startedAt: 0,
      timeLeft: 0,

      // competition
      comp: {
        p1:"", p2:"", mode:"letter", duration:20,
        order:[], currentIndex:0,
        results:{} // {p1:{score,timeUsed}, p2:{...}}
      }
    };

    // ---------- DOM Utils ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const show = id => {
      $$(".page").forEach(p => p.classList.remove("active"));
      $(id).classList.add("active");
    };

    // ---------- UI Layer ----------
    const ui = {
      checkStartReady(){
        const ok = $("#playerName").value.trim() !== "";
        $("#goLeaderboard").disabled = !ok;
      },
      paintLetter(){
        const el = $("#letter");
        const item = state.history[state.idx] || "ÿ®Ÿé";
        el.textContent = item;
        el.className = "letter " + (state.idx % 2 === 0 ? "red" : "blue");
      },
      paintKpis(){
        $("#score").textContent = state.score;
        $("#timer").textContent = state.timeLeft;
        $("#modeChip").textContent = state.mode === "letter" ? "Letter" : "word";
        $("#gameTitle").textContent = state.mode === "letter" ? "Letter Reading" : "words Reading";
      },
      leaderboard(containerId){
        const scores = storage.getScores();
        const container = $(containerId);
        if(!scores.length){
          container.innerHTML = `<div class="empty">‡¥á‡¥§‡µÅ‡¥µ‡¥∞‡µÜ ‡¥∏‡µç‡¥ï‡µã‡¥±‡µÅ‡¥ï‡¥≥‡µä‡¥®‡µç‡¥®‡µÅ‡¥Æ‡¥ø‡¥≤‡µç‡¥≤. ‡¥Ü‡¥¶‡µç‡¥Ø‡¥§‡µç‡¥§‡µÜ ‡¥ï‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥∞‡¥®‡¥æ‡¥ï‡µÇ!</div>`;
          return;
        }
        const top3 = scores.slice(0,3);
        const ranks = ['ü•á','ü•à','ü•â'];
        const classes = ['first','second','third'];
        container.innerHTML = top3.map((s,i)=>`
          <div class="leaderboard-item ${classes[i]}">
            <div><span class="rank">${ranks[i]}</span> ${s.name}</div>
            <div>${s.score} ‚Ä¢ ${s.mode} ‚Ä¢ ${s.duration}s</div>
          </div>
        `).join("");
      }
    };

    // ---------- Storage & Sync ----------
    const storage = {
      key: "harakahScoresV2",
      getScores(){
        try{
          const raw = localStorage.getItem(this.key);
          return raw ? JSON.parse(raw) : [];
        }catch(e){ return []; }
      },
      saveScore(entry){
        const all = this.getScores();
        all.push(entry);
        all.sort((a,b)=> b.score - a.score || a.timeUsed - b.timeUsed);
        localStorage.setItem(this.key, JSON.stringify(all));
        // Optional: fire-and-forget webhook for server sync (configure endpoint below)
        sync.submitScore(entry);
      },
      reset(){
        localStorage.removeItem(this.key);
      }
    };

    // ----- Secure Sync Hook (client ‚Üí your server) -----
    const sync = {
      endpoint: "", // <<< set to your server endpoint (see notes below)
      submitScore(entry){
        if(!this.endpoint) return; // no-op if not configured
        try{
          fetch(this.endpoint, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({type:"score", payload: entry})
          }).catch(()=>{});
        }catch(e){}
      }
    };

    // ---------- Engine ----------
    const pools = {
      nextItem(){
        const pool = state.mode === "letter" ? lettersPool : verbsPool;
        return pool[Math.floor(Math.random()*pool.length)];
      }
    };

    const engine = {
      prepareRun({mode, duration}){
        state.mode = mode;
        state.duration = duration;
        state.history = [];
        state.idx = -1;
        state.score = 0;
        state.timeLeft = duration;
        state.gameActive = false;
        clearInterval(state.timer);
        $("#startBtn").style.display = "block";
        $("#nextBtn").disabled = true;
        $("#prevBtn").disabled = true;
        ui.paintKpis();
        // Seed first item for UX (visible even before start)
        state.history.push(pools.nextItem());
        state.idx = 0;
        ui.paintLetter();
      },
      startTimer(){
        if(state.gameActive) return;
        state.gameActive = true;
        $("#startBtn").style.display = "none";
        $("#nextBtn").disabled = false;
        $("#prevBtn").disabled = false;
        state.startedAt = Date.now();
        clearInterval(state.timer);
        state.timeLeft = state.duration;
        ui.paintKpis();
        state.timer = setInterval(()=>{
          state.timeLeft--;
          $("#timer").textContent = state.timeLeft;
          if(state.timeLeft <= 0){
            clearInterval(state.timer);
            state.gameActive = false;
            $("#nextBtn").disabled = true;
            $("#prevBtn").disabled = true;
            flows.endCurrentRun();
          }
        },1000);
      },
      next(){
        if(!state.gameActive) return;
        // advancing adds score when we generate a new fresh item
        const fresh = pools.nextItem();
        state.history.push(fresh);
        state.idx = state.history.length-1;
        state.score++;
        ui.paintLetter();
        ui.paintKpis();
        $("#prevBtn").disabled = (state.idx===0);
      },
      previous(){
        if(state.idx>0){
          state.idx--;
          ui.paintLetter();
          $("#prevBtn").disabled = (state.idx===0);
        }
      }
    };

    // ---------- Flows ----------
    const flows = {
      toLeaderboard(){
        state.player = $("#playerName").value.trim();
        state.mode = $("#mode").value;
        state.duration = parseInt($("#duration").value,10);
        ui.leaderboard("#leaderboardDisplay");
        show("#page2");
      },
      startSolo(){
        engine.prepareRun({mode: state.mode, duration: state.duration});
        show("#page3");
      },
      cancelRun(){
        clearInterval(state.timer);
        state.gameActive = false;
        show("#page2");
      },
      endCurrentRun(){
        // compute time used
        const timeUsed = state.duration - Math.max(state.timeLeft,0);
        // persist
        storage.saveScore({
          name: state.player || "Player",
          score: state.score,
          duration: state.duration,
          mode: state.mode,
          timeUsed,
          date: new Date().toISOString()
        });
        // results view
        $("#yourScore").textContent = state.score;
        $("#timeUsed").textContent = timeUsed;
        $("#resultMode").textContent = state.mode === "letter" ? "Letter" : "word";
        // rank & congrats for top 3
        const all = storage.getScores();
        const idx = all.findIndex(s => s.name===state.player && s.score===state.score && s.timeUsed===timeUsed);
        const congrats = $("#congratsMessage");
        if(idx > -1 && idx < 3){
          const msgs = ['üéâ ‡¥í‡¥®‡µç‡¥®‡¥æ‡¥Ç ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Ç! ü•á','üéä ‡¥∞‡¥£‡µç‡¥ü‡¥æ‡¥Ç ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Ç! ü•à','üëè ‡¥Æ‡µÇ‡¥®‡µç‡¥®‡¥æ‡¥Ç ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Ç! ü•â'];
          congrats.innerHTML = `<div class="congrats">${msgs[idx]}</div>`;
        }else{
          congrats.innerHTML = "";
        }
        // refresh final leaderboard
        const top3 = all.slice(0,3);
        const ranks = ['ü•á','ü•à','ü•â']; const classes = ['first','second','third'];
        $("#finalLeaderboard").innerHTML = top3.length
          ? top3.map((s,i)=>`
            <div class="leaderboard-item ${classes[i]}">
              <div><span class="rank">${ranks[i]}</span> ${s.name}</div>
              <div>${s.score} ‚Ä¢ ${s.mode} ‚Ä¢ ${s.duration}s</div>
            </div>`).join("")
          : `<div class="empty">‡¥á‡¥§‡µÅ‡¥µ‡¥∞‡µÜ ‡¥∏‡µç‡¥ï‡µã‡¥±‡µÅ‡¥ï‡¥≥‡µä‡¥®‡µç‡¥®‡µÅ‡¥Æ‡¥ø‡¥≤‡µç‡¥≤.</div>`;
        show("#page4");
      },
      playAgain(){
        ui.leaderboard("#leaderboardDisplay");
        show("#page2");
      },
      newPlayer(){
        $("#playerName").value = "";
        $("#mode").value = "letter";
        $("#duration").value = "20";
        ui.checkStartReady();
        show("#page1");
      },
      toCompetitionSetup(){
        $("#p1").value = "";
        $("#p2").value = "";
        $("#compMode").value = "letter";
        $("#compDur").value = "20";
        show("#page5");
      }
    };

    // ---------- Competition ----------
    const competition = {
      start(){
        const p1 = $("#p1").value.trim();
        const p2 = $("#p2").value.trim();
        const mode = $("#compMode").value;
        const duration = parseInt($("#compDur").value,10);
        if(!p1 || !p2){ alert("‡¥∞‡¥£‡µç‡¥ü‡µç ‡¥™‡µá‡¥∞‡µÅ‡¥ü‡µÜ ‡¥™‡µá‡¥∞‡µÅ‡¥ï‡¥≥‡µÅ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."); return; }
        state.comp.p1 = p1; state.comp.p2 = p2; state.comp.mode = mode; state.comp.duration = duration;
        // randomize who starts
        state.comp.order = Math.random() < 0.5 ? [p1,p2] : [p2,p1];
        state.comp.currentIndex = 0;
        state.comp.results = {};
        this._announceAndRunNext();
      },
      _announceAndRunNext(){
        const current = state.comp.order[state.comp.currentIndex];
        state.player = current;
        engine.prepareRun({mode: state.comp.mode, duration: state.comp.duration});
        $("#gameTitle").textContent = `‡¥Æ‡¥§‡µç‡¥∏‡¥∞‡¥Ç ‚Äî ${current}`;
        show("#page3");
      },
      onRoundEnd(score, timeUsed){
        const current = state.comp.order[state.comp.currentIndex];
        state.comp.results[current] = {score, timeUsed};
        // store into global scores also
        storage.saveScore({
          name: current,
          score,
          duration: state.comp.duration,
          mode: state.comp.mode,
          timeUsed,
          date: new Date().toISOString()
        });
        if(state.comp.currentIndex === 0){
          // move to next player
          state.comp.currentIndex = 1;
          this._announceAndRunNext();
        }else{
          // both done ‚Üí compute winner
          this._finishCompetition();
        }
      },
      _finishCompetition(){
        const [A,B] = state.comp.order;
        const a = state.comp.results[A], b = state.comp.results[B];
        const winner =
          (a.score > b.score) ? A :
          (b.score > a.score) ? B :
          (a.timeUsed < b.timeUsed) ? A :
          (b.timeUsed < a.timeUsed) ? B : "tie";

        const congr = $("#compCongrats");
        if(winner === "tie"){
          congr.innerHTML = `<div class="congrats">ü§ù ‡¥∏‡¥Æ‡¥Ç! ‡¥á‡¥∞‡µÅ‡¥µ‡¥∞‡µÅ‡¥Ç ‡¥Æ‡¥ø‡¥ï‡¥ö‡µç‡¥ö ‡¥™‡µç‡¥∞‡¥ï‡¥ü‡¥®‡¥Ç!</div>`;
        }else{
          congr.innerHTML = `<div class="congrats">üèÜ ‡¥Ö‡¥≠‡¥ø‡¥®‡¥®‡µç‡¥¶‡¥®‡¥ô‡µç‡¥ô‡µæ, <b>${winner}</b>!</div>`;
        }

        $("#compSummary").innerHTML = `
          <div class="leaderboard-item">
            <div><b>${A}</b></div>
            <div>‡¥∏‡µç‡¥ï‡µã‡µº: ${a.score} ‚Ä¢ ‡¥∏‡¥Æ‡¥Ø‡¥Ç: ${a.timeUsed}s</div>
          </div>
          <div class="leaderboard-item">
            <div><b>${B}</b></div>
            <div>‡¥∏‡µç‡¥ï‡µã‡µº: ${b.score} ‚Ä¢ ‡¥∏‡¥Æ‡¥Ø‡¥Ç: ${b.timeUsed}s</div>
          </div>
        `;
        show("#page6");
      }
    };

    // Hook competition into solo flow end
    const originalEnd = flows.endCurrentRun.bind(flows);
    flows.endCurrentRun = function(){
      const timeUsed = state.duration - Math.max(state.timeLeft,0);
      const isCompetition = state.comp.order && state.comp.order.length && state.comp.currentIndex <= 1 && (state.player === state.comp.order[state.comp.currentIndex]);
      if(isCompetition){
        // capture current state for competition, then delegate
        const snapshotScore = state.score;
        competition.onRoundEnd(snapshotScore, timeUsed);
      }else{
        originalEnd();
      }
    };

    // ---------- Admin ----------
    const admin = {
      resetAllData(){
        const password = prompt('‡¥±‡µÄ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥™‡¥æ‡¥∏‡µç‚Äå‡¥µ‡µá‡¥°‡µç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï:');
        if(password === 'shahi321'){
          if(confirm('‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥±‡µÜ‡¥ï‡µç‡¥ï‡µã‡µº‡¥°‡µÅ‡¥ï‡¥≥‡µÅ‡¥Ç ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡¥£‡¥Æ‡µÜ‡¥®‡µç‡¥®‡µç ‡¥â‡¥±‡¥™‡µç‡¥™‡¥æ‡¥£‡µã?')){
            try{ storage.reset(); alert('‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥±‡µÜ‡¥ï‡µç‡¥ï‡µã‡µº‡¥°‡µÅ‡¥ï‡¥≥‡µÅ‡¥Ç ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡¥æ‡¥ï‡µç‡¥ï‡¥ø!'); }
            catch(e){ alert('Error: localStorage may not be available'); }
          }
        }else if(password !== null){
          alert('‡¥§‡µÜ‡¥±‡µç‡¥±‡¥æ‡¥Ø ‡¥™‡¥æ‡¥∏‡µç‚Äå‡¥µ‡µá‡¥°‡µç!');
        }
      }
    };

    // ---------- Init ----------
    (function init(){
      ui.checkStartReady();
    })();
  </script>
</body>
</html>
